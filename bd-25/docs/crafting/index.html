<!DOCTYPE html><html data-theme="dark"> <head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="description" content="crafting"><meta name="author" content="MDXpress"><title>crafting</title><link rel="icon" type="image/svg+xml" href="/bd-25/favicon.svg"><link rel="stylesheet" href="/bd-25/_astro/_slug_.FGKI9IMe.css"></head> <body> <div class="app"> <nav class="navigation"> <h1 class="navigation-header">docs</h1> <hr> <ul class="tree"> <li class="tree-node"> <a href="/bd-25/docs/architecture" class="tree-link"> <span class="tree-file-icon"></span> ARCHITECTURE.md </a>  </li><li class="tree-node"> <a href="/bd-25/docs/assets" class="tree-link"> <span class="tree-file-icon"></span> ASSETS.mdx </a>  </li><li class="tree-node"> <a href="/bd-25/docs/biomes" class="tree-link"> <span class="tree-file-icon"></span> BIOMES.md </a>  </li><li class="tree-node"> <a href="/bd-25/docs/collectibles" class="tree-link"> <span class="tree-file-icon"></span> COLLECTIBLES.md </a>  </li><li class="tree-node"> <a href="/bd-25/docs/concept" class="tree-link"> <span class="tree-file-icon"></span> CONCEPT.mdx </a>  </li><li class="tree-node"> <a href="/bd-25/docs/crafting" class="tree-link active"> <span class="tree-file-icon"></span> CRAFTING.md </a>  </li><li class="tree-node"> <a href="/bd-25/docs/features" class="tree-link"> <span class="tree-file-icon"></span> FEATURES.md </a>  </li><li class="tree-node"> <a href="/bd-25/docs/performance" class="tree-link"> <span class="tree-file-icon"></span> PERFORMANCE.md </a>  </li><li class="tree-node"> <a href="/bd-25/docs/persistence" class="tree-link"> <span class="tree-file-icon"></span> PERSISTENCE.md </a>  </li><li class="tree-node"> <a href="/bd-25/docs/testing" class="tree-link"> <span class="tree-file-icon"></span> TESTING.md </a>  </li> </ul> </nav> <main class="main-content"> <div class="doc-content"> <h2 id="colored-sand-crafting-system">Colored Sand Crafting System</h2>
<h3 id="status">Status</h3>
<p>Design Phase – Implementation pending (inventory removal helpers, crafting module, HUD modal, tests). This document defines the initial crafting feature focused on converting base sand (Yellow) plus a single flower into colored sand blocks. Keeps HUD minimal by using a modal opened from a dedicated HudOption.</p>
<hr>
<h2 id="1-goals">1. Goals</h2>
<ol>
<li>Enable players to transform Yellow sand blocks into colored sand variants using flowers.</li>
<li>Maintain a minimal HUD: crafting interaction lives inside a modal invoked by a single HudOption icon.</li>
<li>Guarantee atomic crafting transactions (all inputs consumed only if outputs can be fully added to inventory).</li>
<li>Provide deterministic distribution for mixed output recipes (red flower 50/50 split) for predictable player experience.</li>
<li>Avoid clutter: flowers remain a hidden resource except aggregate count badge and crafting modal.</li>
</ol>
<p>Non-goals (first iteration): batch multi-flower recipes, partial output on inventory overflow, asynchronous crafting timers, animation/sound polish, recipe discovery mechanics.</p>
<hr>
<h2 id="2-terminology">2. Terminology</h2>





























<table><thead><tr><th>Term</th><th>Meaning</th></tr></thead><tbody><tr><td>Flower</td><td>A collected object (ObjectId) with id starting <code>flower_</code>. Consumed as catalyst.</td></tr><tr><td>Sand (Base)</td><td>The Yellow block (<code>assets.blocks.sprites.Yellow</code>) used as input.</td></tr><tr><td>Colored Sand</td><td>Output blocks (Red, LightRed, LightCyan, Cyan (Turquoise fallback), Blue, Magenta, LightMagenta).</td></tr><tr><td>Crafting Transaction</td><td>Single action consuming 1 flower + N base sand (1..10) producing N colored sand blocks.</td></tr><tr><td>Recipe</td><td>Mapping flower id -> output distribution rule.</td></tr></tbody></table>
<hr>
<h2 id="3-input--output-contract">3. Input / Output Contract</h2>
<p>Contract (single craft operation):</p>
<ul>
<li>Inputs: exactly 1 flower object + <code>n</code> Yellow sand blocks where <code>1 &#x3C;= n &#x3C;= 10</code> and inventory holds at least <code>n</code> Yellow.</li>
<li>Output count: exactly <code>n</code> blocks (one-for-one conversion, no multiplier).</li>
<li>Output kind distribution per flower:
<ul>
<li><code>flower_red</code> -> 50% Red, 50% LightRed (odd counts: extra goes to Red first)</li>
<li><code>flower_cyan</code> -> 100% LightCyan</li>
<li><code>flower_turquoise</code> -> 100% Cyan</li>
<li><code>flower_blue</code> -> 100% Blue</li>
<li><code>flower_purple</code> -> 100% Magenta</li>
<li><code>flower_pink</code> -> 100% LightMagenta</li>
</ul>
</li>
</ul>
<p>Failure Modes:</p>
<ul>
<li>No eligible flower selected → UI disables craft button.</li>
<li>Sand amount zero → UI disables craft button.</li>
<li>Insufficient Yellow sand → UI disables craft button.</li>
<li>Inventory does not have space for all output stacks → transaction aborted, show error.</li>
</ul>
<p>Atomicity: On success remove 1 flower + <code>n</code> Yellow, then add output blocks. If any addition fails mid-way, rollback (re-add removed inputs) and present failure message.</p>
<hr>
<h2 id="4-recipes-data-structure">4. Recipes Data Structure</h2>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#F97583">interface</span><span style="color:#B392F0"> CraftRecipe</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">  id</span><span style="color:#F97583">:</span><span style="color:#B392F0"> ObjectId</span><span style="color:#E1E4E8">;                 </span><span style="color:#6A737D">// flower id</span></span>
<span class="line"><span style="color:#B392F0">  distribute</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">n</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> { </span><span style="color:#FFAB70">block</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Block</span><span style="color:#E1E4E8">; </span><span style="color:#FFAB70">count</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8"> }[]; </span><span style="color:#6A737D">// deterministic</span></span>
<span class="line"><span style="color:#FFAB70">  description</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;          </span><span style="color:#6A737D">// shown in modal</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Implementation details:</p>
<ul>
<li>Use a recipe map keyed by flower id.</li>
<li>For mixed distribution (red) implement integer split: <code>Math.floor(n/2)</code> LightRed, remainder Red.</li>
</ul>
<hr>
<h2 id="5-inventory-api-additions">5. Inventory API Additions</h2>
<p>New methods required:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#B392F0">removeBlock</span><span style="color:#E1E4E8">(block: Block, count: number): boolean;      </span><span style="color:#6A737D">// all-or-nothing</span></span>
<span class="line"><span style="color:#B392F0">removeObject</span><span style="color:#E1E4E8">(id: ObjectId, count</span><span style="color:#F97583">?:</span><span style="color:#E1E4E8"> number): boolean;     </span><span style="color:#6A737D">// default count=1</span></span>
<span class="line"><span style="color:#B392F0">addMany</span><span style="color:#E1E4E8">(block: Block, count: number): boolean;          </span><span style="color:#6A737D">// treat stacks; returns false if cannot add all</span></span></code></pre>
<p>Rollback helper could snapshot affected slots or perform inverse operations immediately if failure occurs during output addition.</p>
<hr>
<h2 id="6-crafting-module-craftingts">6. Crafting Module (<code>Crafting.ts</code>)</h2>
<p>Responsibilities:</p>
<ul>
<li>Validation (<code>validateCraft(flowerId, sandCount, inventory)</code>)</li>
<li>Simulation (<code>simulate(flowerId, sandCount)</code> returns distribution for preview)</li>
<li>Execution (<code>executeCraft(flowerId, sandCount, inventory)</code> returns result object <code>{ ok, outputs, error? }</code>)</li>
</ul>
<p>Pseudo-code:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#F97583">function</span><span style="color:#B392F0"> executeCraft</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">flowerId</span><span style="color:#F97583">:</span><span style="color:#B392F0"> ObjectId</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">n</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">inv</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Inventory</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> CraftResult</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> recipe</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> RECIPES</span><span style="color:#E1E4E8">[flowerId];</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">recipe) </span><span style="color:#F97583">return</span><span style="color:#E1E4E8"> { ok: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, error: </span><span style="color:#9ECBFF">'Unknown recipe'</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (n </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 1</span><span style="color:#F97583"> ||</span><span style="color:#E1E4E8"> n </span><span style="color:#F97583">></span><span style="color:#79B8FF"> 10</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">return</span><span style="color:#E1E4E8"> { ok: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, error: </span><span style="color:#9ECBFF">'Invalid sand amount'</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">inv.</span><span style="color:#B392F0">has</span><span style="color:#E1E4E8">(Yellow) </span><span style="color:#F97583">||</span><span style="color:#E1E4E8"> inv.</span><span style="color:#B392F0">count</span><span style="color:#E1E4E8">(Yellow) </span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8"> n) </span><span style="color:#F97583">return</span><span style="color:#E1E4E8"> { ok: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, error: </span><span style="color:#9ECBFF">'Not enough sand'</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">inv.</span><span style="color:#B392F0">hasObject</span><span style="color:#E1E4E8">(flowerId)) </span><span style="color:#F97583">return</span><span style="color:#E1E4E8"> { ok: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, error: </span><span style="color:#9ECBFF">'Flower missing'</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> outputs</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> recipe.</span><span style="color:#B392F0">distribute</span><span style="color:#E1E4E8">(n);</span></span>
<span class="line"><span style="color:#6A737D">  // Check capacity</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#B392F0">canAddAll</span><span style="color:#E1E4E8">(inv, outputs)) </span><span style="color:#F97583">return</span><span style="color:#E1E4E8"> { ok: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, error: </span><span style="color:#9ECBFF">'Inventory full'</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"><span style="color:#6A737D">  // Apply (atomic)</span></span>
<span class="line"><span style="color:#E1E4E8">  inv.</span><span style="color:#B392F0">removeObject</span><span style="color:#E1E4E8">(flowerId);</span></span>
<span class="line"><span style="color:#E1E4E8">  inv.</span><span style="color:#B392F0">removeBlock</span><span style="color:#E1E4E8">(Yellow, n);</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#B392F0">addAll</span><span style="color:#E1E4E8">(inv, outputs)) {</span></span>
<span class="line"><span style="color:#6A737D">    // rollback</span></span>
<span class="line"><span style="color:#E1E4E8">    inv.</span><span style="color:#B392F0">addObject</span><span style="color:#E1E4E8">(flowerId);</span></span>
<span class="line"><span style="color:#E1E4E8">    inv.</span><span style="color:#B392F0">addMany</span><span style="color:#E1E4E8">(Yellow, n);</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> { ok: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, error: </span><span style="color:#9ECBFF">'Inventory overflow during add'</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#E1E4E8"> { ok: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">, outputs };</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<hr>
<h2 id="7-hud--modal-integration">7. HUD &#x26; Modal Integration</h2>
<p>HUD Changes:</p>
<ul>
<li>Add new HudOption (“craft”) with beaker icon ⚗️.</li>
<li>Clicking it toggles <code>&#x3C;craft-modal></code> (overlay panel centered).</li>
</ul>
<p>Modal <code>&#x3C;craft-modal></code>:</p>
<ul>
<li>Flower selection (sprite icons with counts; click to select a flower catalyst).</li>
<li>Sand amount selector (range 1..10 clamped by available Yellow count).</li>
<li>Live preview of output distribution (colored block icons + counts).</li>
<li>Craft button (HudOption styling) disabled until valid; shows reason in <code>title</code> attribute.</li>
<li>Close controls: ESC key, backdrop click, or success.</li>
</ul>
<p>Minimalism: Modal only appears when actively crafting; HUD itself adds exactly one icon. No persistent extra panels.</p>
<hr>
<h2 id="8-ui-states--feedback">8. UI States &#x26; Feedback</h2>
<p>States:</p>
<ol>
<li>Empty (no flowers) → message “No flowers collected”; craft disabled.</li>
<li>Insufficient sand → display current vs required.</li>
<li>Overflow risk → message advising freeing inventory space.</li>
<li>Success → transient confirmation (e.g. fade-out toast) then modal auto-closes.</li>
</ol>
<p>Accessibility Considerations: Use semantic buttons, focus first interactive element, ESC to close, ARIA role <code>dialog</code> with <code>aria-modal="true"</code>.</p>
<hr>
<h2 id="9-testing-strategy">9. Testing Strategy</h2>
<p>Unit Tests (Vitest):</p>
<ul>
<li>Red recipe splitting even/odd counts.</li>
<li>Each 100% recipe outputs correct block id and count.</li>
<li>Blocked yellow flower returns error; inventory unaffected.</li>
<li>Insufficient sand count error.</li>
<li>Inventory space failure triggers rollback (flower + sand unchanged).</li>
<li>Maximum sand (10) success path.</li>
</ul>
<p>Integration-esque:</p>
<ul>
<li>Simulate inventory with multiple flowers &#x26; sand; execute craft; ensure HUD update call expected.</li>
</ul>
<p>Edge Cases:</p>
<ul>
<li>Sand count exactly matches remaining stack capacity for output blocks.</li>
<li>Inventory nearly full (adding outputs require new slot vs merge).</li>
</ul>
<hr>
<h2 id="10-performance--limits">10. Performance &#x26; Limits</h2>
<ul>
<li>Max sand per craft: 10 (tiny scope → negligible performance impact).</li>
<li>Distribution function O(1) per output kind (worst-case 2 entries for red split).</li>
<li>Modal instantiation on demand; no persistent interval updates.</li>
</ul>
<hr>
<h2 id="11-future-enhancements">11. Future Enhancements</h2>

































<table><thead><tr><th>Idea</th><th>Description</th></tr></thead><tbody><tr><td>DarkCyan Asset</td><td>Add new block sprite enabling distinct turquoise output.</td></tr><tr><td>Multi-Flower Boost</td><td>More flowers => multiplier (e.g., 1 flower + 10 sand → 12 colored).</td></tr><tr><td>Discovery System</td><td>Unlock recipes on first flower collection.</td></tr><tr><td>Craft Queue</td><td>Batch multiple crafts before closing modal.</td></tr><tr><td>Particle Effects</td><td>Sand tinting animation during craft.</td></tr><tr><td>Sound Feedback</td><td>Success / failure audio cues.</td></tr></tbody></table>
<hr>
<h2 id="12-open-questions">12. Open Questions</h2>
<ol>
<li>Should sand amount 0 be allowed for preview only? (Currently disallow.)</li>
<li>Rollback strategy acceptable or should we pre-check slot capacity more deeply to avoid partial add attempts?</li>
</ol>
<hr>
<h2 id="13-implementation-checklist">13. Implementation Checklist</h2>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>1. [x] Extend Inventory (removeBlock, removeObject, addMany, hasObject, count helpers)</span></span>
<span class="line"><span>2. [x] Add 'craft' to Option union &#x26; HUD icon</span></span>
<span class="line"><span>3. [x] Create Crafting.ts (recipes, simulate, execute)</span></span>
<span class="line"><span>4. [x] Implement &#x3C;craft-modal> custom element</span></span>
<span class="line"><span>5. [x] Integrate HUD option toggling modal</span></span>
<span class="line"><span>6. [x] Wire CraftResult HUD refresh workflow</span></span>
<span class="line"><span>7. [x] Add unit tests for crafting logic</span></span>
<span class="line"><span>8. [x] Update COLLECTIBLES.md (link to crafting doc) or cross-reference</span></span>
<span class="line"><span>9. [ ] Optional: toast feedback on success/failure</span></span></code></pre>
<hr>
<h2 id="14-quick-reference">14. Quick Reference</h2>





























<table><thead><tr><th>Concern</th><th>Location</th></tr></thead><tbody><tr><td>Recipes Map</td><td><code>Crafting.ts</code> RECIPES constant</td></tr><tr><td>Yellow block id</td><td><code>assets.blocks.sprites.Yellow</code></td></tr><tr><td>Flower ids</td><td><code>assets.objects.sprites.*</code> with <code>flower_</code> prefix</td></tr><tr><td>Modal element</td><td><code>&#x3C;craft-modal></code> (shadow DOM recommended)</td></tr><tr><td>Execution entry</td><td><code>executeCraft()</code></td></tr></tbody></table>
<hr>
<p>End of design.</p> </div> </main> <div class="backdrop"></div> <div class="app-actions"> <label for="theme-toggle" class="theme-toggle unified-button" role="button" aria-roledescription="Toggle between dark and light mode" aria-label="Toggle between dark and light mode" title="Toggle between dark and light mode"> <input type="checkbox" id="theme-toggle"> <svg class="theme-toggle-icon light" width="16" height="16" viewBox="0 0 16 16" fill="currentColor"> <path d="M8 12a4 4 0 1 1 0-8 4 4 0 0 1 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path> </svg> <svg class="theme-toggle-icon dark" width="16" height="16" viewBox="0 0 16 16" fill="currentColor"> <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path> </svg> </label> <label for="mobile-menu-toggle" class="mobile-menu-toggle unified-button" role="button" aria-roledescription="Open and close the mobile menu" aria-label="Open and close the mobile menu" title="Open and close the mobile menu"> <input type="checkbox" id="mobile-menu-toggle"> <span class="mobile-menu-toggle-icon closed">☰</span> <span class="mobile-menu-toggle-icon opened">✕</span> </label> </div> </div> </body></html>