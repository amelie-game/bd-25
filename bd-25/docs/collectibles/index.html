<!DOCTYPE html><html data-theme="dark"> <head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="description" content="collectibles"><meta name="author" content="MDXpress"><title>collectibles</title><link rel="icon" type="image/svg+xml" href="/bd-25/favicon.svg"><link rel="stylesheet" href="/bd-25/_astro/_slug_.FGKI9IMe.css"></head> <body> <div class="app"> <nav class="navigation"> <h1 class="navigation-header">docs</h1> <hr> <ul class="tree"> <li class="tree-node"> <a href="/bd-25/docs/architecture" class="tree-link"> <span class="tree-file-icon"></span> ARCHITECTURE.md </a>  </li><li class="tree-node"> <a href="/bd-25/docs/assets" class="tree-link"> <span class="tree-file-icon"></span> ASSETS.mdx </a>  </li><li class="tree-node"> <a href="/bd-25/docs/biomes" class="tree-link"> <span class="tree-file-icon"></span> BIOMES.md </a>  </li><li class="tree-node"> <a href="/bd-25/docs/collectibles" class="tree-link active"> <span class="tree-file-icon"></span> COLLECTIBLES.md </a>  </li><li class="tree-node"> <a href="/bd-25/docs/concept" class="tree-link"> <span class="tree-file-icon"></span> CONCEPT.mdx </a>  </li><li class="tree-node"> <a href="/bd-25/docs/crafting" class="tree-link"> <span class="tree-file-icon"></span> CRAFTING.md </a>  </li><li class="tree-node"> <a href="/bd-25/docs/features" class="tree-link"> <span class="tree-file-icon"></span> FEATURES.md </a>  </li><li class="tree-node"> <a href="/bd-25/docs/performance" class="tree-link"> <span class="tree-file-icon"></span> PERFORMANCE.md </a>  </li><li class="tree-node"> <a href="/bd-25/docs/persistence" class="tree-link"> <span class="tree-file-icon"></span> PERSISTENCE.md </a>  </li><li class="tree-node"> <a href="/bd-25/docs/testing" class="tree-link"> <span class="tree-file-icon"></span> TESTING.md </a>  </li> </ul> </nav> <main class="main-content"> <div class="doc-content"> <h2 id="collectible-objects-flowers--future-resources">Collectible Objects (Flowers &#x26; Future Resources)</h2>
<h3 id="status">Status</h3>
<p>In Progress – Steps 1–12 implemented &#x26; tested (types, persistence, generation, rendering, object-first collection, HUD badge, density &#x26; biome tests, collection &#x26; persistence tests). This update adds cross-references to the colored sand crafting system. Remaining: Step 14 (manual QA &#x26; tuning), future crafting &#x26; enhancements.</p>
<p>Quick Links: <a href="./CRAFTING.md">Colored Sand Crafting System</a> – see design &#x26; recipes.</p>
<hr>
<h2 id="1-goals">1. Goals</h2>
<ol>
<li>Procedurally distribute flower objects on grass-biome islands (per chunk).</li>
<li>Player collection prioritizes an object (flower) over ground tile mutation when present.</li>
<li>Collected flower:
<ul>
<li>Added to inventory (stacking logic similar to blocks, but as a distinct item kind).</li>
<li>Removed visually and from world state.</li>
</ul>
</li>
<li>Flower presence / absence persists (survives reload) just like mutated tiles.</li>
<li>Keep architecture forward-compatible for additional object types (rocks) and richer metadata (durability, growth, etc.).</li>
</ol>
<p>Non-goals (for this first pass): regrowth, tool requirements, animation, deterministic baseline diff compression (we store full object list initially), multi-layer pathfinding interactions.</p>
<hr>
<h2 id="2-terminology">2. Terminology</h2>

























<table><thead><tr><th>Term</th><th>Meaning</th></tr></thead><tbody><tr><td>Tile</td><td>Terrain base (numeric ID sourced from <code>assets.blocks.sprites</code>).</td></tr><tr><td>Object</td><td>A collectible entity placed “on” a tile (flower, rock). Not encoded as tile ID.</td></tr><tr><td>Chunk</td><td>100×100 tile region (see <code>CHUNK_TILES</code>). Owns tiles + objects.</td></tr><tr><td>Overlay Diff</td><td>Sparse tile mutations relative to baseline.</td></tr></tbody></table>
<hr>
<h2 id="3-data-model-additions">3. Data Model Additions</h2>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#6A737D">// Object identity (matches frame names in objects atlas)</span></span>
<span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> ObjectId</span><span style="color:#F97583"> =</span></span>
<span class="line"><span style="color:#F97583">  |</span><span style="color:#9ECBFF"> 'flower_red'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'flower_cyan'</span></span>
<span class="line"><span style="color:#F97583">  |</span><span style="color:#9ECBFF"> 'flower_turquoise'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'flower_blue'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'flower_purple'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'flower_pink'</span></span>
<span class="line"><span style="color:#6A737D">  // (rocks reserved for later)</span></span>
<span class="line"><span style="color:#E1E4E8">  ;</span></span>
<span class="line"><span style="color:#F97583">interface</span><span style="color:#B392F0"> WorldObject</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">  id</span><span style="color:#F97583">:</span><span style="color:#B392F0"> ObjectId</span><span style="color:#E1E4E8">;          </span><span style="color:#6A737D">// atlas frame key</span></span>
<span class="line"><span style="color:#FFAB70">  i</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;             </span><span style="color:#6A737D">// linear tile index (tx + ty * CHUNK_TILES)</span></span>
<span class="line"><span style="color:#FFAB70">  sprite</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Phaser</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">GameObjects</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Image</span><span style="color:#E1E4E8">; </span><span style="color:#6A737D">// runtime only (not serialized)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">interface</span><span style="color:#B392F0"> SerializedObjectEntry</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">  i</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;  </span><span style="color:#6A737D">// linear tile index</span></span>
<span class="line"><span style="color:#FFAB70">  k</span><span style="color:#F97583">:</span><span style="color:#B392F0"> ObjectId</span><span style="color:#E1E4E8">; </span><span style="color:#6A737D">// kind / frame key</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">interface</span><span style="color:#B392F0"> SerializedChunk</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  ...</span></span>
<span class="line"><span style="color:#FFAB70">  objects</span><span style="color:#F97583">?:</span><span style="color:#B392F0"> SerializedObjectEntry</span><span style="color:#E1E4E8">[]; </span><span style="color:#6A737D">// Optional full snapshot (first implementation)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Inventory</span></span>
<span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> InventoryItem</span><span style="color:#F97583"> =</span></span>
<span class="line"><span style="color:#F97583">  |</span><span style="color:#E1E4E8"> { </span><span style="color:#FFAB70">kind</span><span style="color:#F97583">:</span><span style="color:#9ECBFF"> 'block'</span><span style="color:#E1E4E8">; </span><span style="color:#FFAB70">id</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Block</span><span style="color:#E1E4E8">; </span><span style="color:#FFAB70">count</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8"> }</span></span>
<span class="line"><span style="color:#F97583">  |</span><span style="color:#E1E4E8"> { </span><span style="color:#FFAB70">kind</span><span style="color:#F97583">:</span><span style="color:#9ECBFF"> 'object'</span><span style="color:#E1E4E8">; </span><span style="color:#FFAB70">id</span><span style="color:#F97583">:</span><span style="color:#B392F0"> ObjectId</span><span style="color:#E1E4E8">; </span><span style="color:#FFAB70">count</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8"> };</span></span></code></pre>
<p>Rationale: Keep initial persistence simple (complete object list) → easier to reason about, small size (expected dozens max per chunk). Can evolve to diff-of-removals later if a deterministic baseline for objects is introduced.</p>
<hr>
<h2 id="4-procedural-generation-flowers">4. Procedural Generation (Flowers)</h2>
<p>Generation occurs inside <code>World.generateIsland()</code> (or a new helper invoked after tile generation) only if the biome kind is <code>grass</code>.</p>
<p>Algorithm:</p>
<ol>
<li>Inspect all tiles after base land generation.</li>
<li>For each grass tile (not sand/water), with probability <code>p = 1 / FLOWER_DENSITY_DIVISOR</code> attempt placement.</li>
<li>Randomly choose a flower variant with uniform distribution across available frames.</li>
<li>Ensure no duplicate object already at that index.</li>
<li>Store as <code>WorldObject</code> (create sprite) and append to internal object map.</li>
</ol>
<p>Constants (add to <code>constants.ts</code> or a new config file):</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#F97583">export</span><span style="color:#F97583"> const</span><span style="color:#79B8FF"> FLOWER_DENSITY_DIVISOR</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 100</span><span style="color:#E1E4E8">;  </span><span style="color:#6A737D">// tuned from 140 (Step 14) to raise average flower count</span></span>
<span class="line"><span style="color:#F97583">export</span><span style="color:#F97583"> const</span><span style="color:#79B8FF"> OBJECT_DEPTH</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 0.5</span><span style="color:#E1E4E8">;            </span><span style="color:#6A737D">// draw order (ground=0, objects=0.5, player=1, highlight=10)</span></span></code></pre>
<p>Determinism: Use the existing per-chunk RNG (<code>mulberry32(seed)</code>) so flower placement is predictable. Because we are <em>persisting</em> the full object list, determinism is nice but not strictly required for correctness now; it <em>will</em> matter if/when we switch to diff-of-removals.</p>
<hr>
<h2 id="5-world-integration">5. World Integration</h2>
<p>Add to <code>World</code>:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#E1E4E8">private </span><span style="color:#B392F0">objects</span><span style="color:#E1E4E8">: Map</span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8">number, WorldObject</span><span style="color:#F97583">></span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Map</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">addObject</span><span style="color:#E1E4E8">(id: ObjectId, tx: number, ty: number): </span><span style="color:#F97583">void</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#B392F0">getObjectAt</span><span style="color:#E1E4E8">(tx: number, ty: number): WorldObject </span><span style="color:#F97583">|</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#B392F0">removeObjectAt</span><span style="color:#E1E4E8">(tx: number, ty: number): boolean; </span><span style="color:#6A737D">// returns true if removed</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">serializeObjects</span><span style="color:#E1E4E8">(): SerializedObjectEntry[];</span></span>
<span class="line"><span style="color:#B392F0">applySerializedObjects</span><span style="color:#E1E4E8">(list: SerializedObjectEntry[]): </span><span style="color:#F97583">void</span><span style="color:#E1E4E8">;</span></span></code></pre>
<p>Rendering: Each object -> <code>this.shell.add.image(offsetX + tx*TILE_SIZE + TILE_SIZE/2, offsetY + ty*TILE_SIZE + TILE_SIZE/2, assets.objects.key, id)</code> with <code>setDepth(OBJECT_DEPTH)</code>. Destroy sprite when object removed or chunk destroyed.</p>
<p>Persistence hooks:</p>
<ul>
<li>Include <code>objects</code> array inside <code>serializeDiff</code> return value.</li>
<li>In <code>WorldManager.loadExisting</code>, after applying tile diff, if <code>data.objects</code> present → call <code>applySerializedObjects</code>.</li>
<li>Any add/remove triggers <code>onMutate()</code> so chunk save scheduling includes object changes.</li>
</ul>
<p>Backward compatibility: Old saved chunks without <code>objects</code> simply load with none (fine). New code must tolerate <code>objects</code> missing.</p>
<hr>
<h2 id="6-worldmanager-helpers">6. WorldManager Helpers</h2>
<p>Add convenience methods for global coordinates:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#B392F0">getObjectAtGlobal</span><span style="color:#E1E4E8">(tileX: number, tileY: number): WorldObject </span><span style="color:#F97583">|</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#B392F0">removeObjectAtGlobal</span><span style="color:#E1E4E8">(tileX: number, tileY: number): boolean;</span></span></code></pre>
<p>These mirror existing tile helpers and translate global tile coordinates to chunk-local indices.</p>
<hr>
<h2 id="7-collection-flow-changes">7. Collection Flow Changes</h2>
<p>Amend <code>CollectMode.finishCollection(tx, ty)</code> logic:</p>
<ol>
<li>Query <code>worldManager.getObjectAtGlobal(tx, ty)</code>.</li>
<li>If found:
<ul>
<li>Attempt <code>inventory.addObject(obj.id)</code>.</li>
<li>If added, <code>worldManager.removeObjectAtGlobal(tx, ty)</code> and HUD refresh.</li>
<li>Return early (skip tile mutation logic).</li>
</ul>
</li>
<li>Else run existing tile collection logic (tile transforms + adding block to inventory).</li>
</ol>
<p>Collection time: unchanged (1s). Possible future variation per object.</p>
<hr>
<h2 id="8-inventory--hud-adjustments">8. Inventory &#x26; HUD Adjustments</h2>
<p>Inventory changes:</p>
<ul>
<li>Internally store entries as <code>InventoryItem</code> union (already partially implemented).</li>
<li>Expose existing block-centric APIs unchanged for now.</li>
<li>Flowers (object items) are collected and stacked but are NOT rendered in the block HUD bar – they remain hidden resources.</li>
</ul>
<p>HUD decision (updated):</p>
<ul>
<li>Do not add flower icons to the primary block slot strip to avoid clutter.</li>
<li>Future interaction: a crafting / combination UI (not yet implemented) will allow combining a flower with sand blocks to produce colored sand variants. This will consume one flower per batch (design TBD) and tint or swap sand block tiles.</li>
</ul>
<p>Backward compatibility: Since HUD ignores object entries, no immediate visual migration needed. Later, a secondary panel or context menu can expose flower counts when the combination feature is introduced.</p>
<hr>
<h2 id="9-persistence-format-example">9. Persistence Format Example</h2>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="jsonc"><code><span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#79B8FF">  "version"</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">  "worldSeed"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"local-seed"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">  "chunkX"</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">  "chunkY"</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">  "biomeId"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"grass"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">  "diff"</span><span style="color:#E1E4E8">: [ { </span><span style="color:#79B8FF">"i"</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">5050</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">"t"</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">11</span><span style="color:#E1E4E8"> } ],</span></span>
<span class="line"><span style="color:#79B8FF">  "objects"</span><span style="color:#E1E4E8">: [</span></span>
<span class="line"><span style="color:#E1E4E8">    { </span><span style="color:#79B8FF">"i"</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">4321</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">"k"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"flower_red"</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { </span><span style="color:#79B8FF">"i"</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">7890</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">"k"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"flower_blue"</span><span style="color:#E1E4E8"> }</span></span>
<span class="line"><span style="color:#E1E4E8">  ],</span></span>
<span class="line"><span style="color:#79B8FF">  "lastTouched"</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">1730000000000</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>If <code>objects</code> absent, treat as empty list.</p>
<hr>
<h2 id="10-testing-strategy">10. Testing Strategy</h2>
<p>Unit / Integration tests (place in <code>proc/</code> or new test file):</p>
<ol>
<li>Generation Density: For a grass biome chunk, count flowers; assert within expected bounds (e.g., 0 &#x3C; count &#x3C; CHUNK_TILES*CHUNK_TILES / FLOWER_DENSITY_DIVISOR * 2).</li>
<li>Biome Restriction: Desert / snow biome chunks either produce zero flowers.</li>
<li>Collection: Simulate adding a flower at tile, collect → inventory increments, object removed, tile unchanged.</li>
<li>Persistence: After removal, serialize + reload (apply diff &#x26; objects) → ensure flower not present.</li>
<li>Backward Compatibility: Loading a serialized chunk without <code>objects</code> does not throw.</li>
</ol>
<p>Edge cases (manual QA):</p>
<ul>
<li>Collect while moving across chunk boundary.</li>
<li>Collecting multiple flowers quickly (inventory stacking works, no duplicates remain in world).</li>
<li>Saving &#x26; reloading with mixed tile mutations and object removals.</li>
</ul>
<hr>
<h2 id="11-performance-considerations">11. Performance Considerations</h2>
<ul>
<li>Expected flower count per chunk is small (&#x3C; ~80 @ current density). Full list serialization negligible.</li>
<li>Object lookups use a <code>Map&#x3C;number,WorldObject></code> O(1).</li>
<li>Save size overhead: each object entry ~ (index + small string) – acceptable; could compress later.</li>
<li>Future optimization: store baseline deterministic placement and only track removals to reduce I/O.</li>
</ul>
<hr>
<h2 id="12-future-enhancements-not-in-first-pass">12. Future Enhancements (Not in First Pass)</h2>
<ul>
<li>Rocks with longer collection times or tool gating.</li>
<li>Object-specific animations / particle effects on collection.</li>
<li>Regrowth timers or seasonal generation refresh.</li>
<li>Deterministic baseline + diff-of-removals for compact saves.</li>
<li>Object metadata (durability, growth s</li>
<li>tage) via <code>SerializedTileMetaEntry</code> or a parallel <code>objectsMeta</code> extension.</li>
<li>Pathfinding collision if certain objects become blocking.</li>
</ul>
<hr>
<h2 id="13-implementation-checklist">13. Implementation Checklist</h2>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>1. [x] Extend types: ObjectId, InventoryItem, SerializedObjectEntry</span></span>
<span class="line"><span>2. [x] Update IChunkStore interfaces &#x26; version note (optional objects[] field)</span></span>
<span class="line"><span>3. [x] Add object container &#x26; API to World (add/get/remove, serialize/apply)</span></span>
<span class="line"><span>4. [x] Procedural flower generation (grass biome only) with density constant</span></span>
<span class="line"><span>5. [x] Rendering for objects (depth ordering) &#x26; cleanup on destroy</span></span>
<span class="line"><span>6. [x] WorldManager global helpers (get/remove object at global coords)</span></span>
<span class="line"><span>7. [x] Modify CollectMode to prioritize object collection</span></span>
<span class="line"><span>8. [x] Refactor Inventory for union item kind (block/object) &#x26; stacking rules</span></span>
<span class="line"><span>9. [x] Minimal HUD integration (aggregate flower count badge on collect icon; full crafting UI deferred)</span></span>
<span class="line"><span>10. [x] Persistence wiring (save &#x26; load objects field) – verify saves include removals</span></span>
<span class="line"><span>11. [x] Tests: generation density + biome restriction</span></span>
<span class="line"><span>12. [x] Tests: collection flow &#x26; persistence</span></span>
<span class="line"><span>13. [x] Documentation updates (this file – keep in sync if design shifts)</span></span>
<span class="line"><span>14. [ ] Manual QA &#x26; tuning (flower density, visual overlap)</span></span></code></pre>
<hr>
<h2 id="14-risks--mitigations">14. Risks &#x26; Mitigations</h2>





























<table><thead><tr><th>Risk</th><th>Mitigation</th></tr></thead><tbody><tr><td>Inventory / HUD break due to new union type</td><td>Introduce adapters; keep old code paths until fully migrated.</td></tr><tr><td>Save incompatibility</td><td>Optional <code>objects</code> field guarded by presence checks.</td></tr><tr><td>Visual clutter / performance with too many objects</td><td>Density constant tweak; future culling if needed.</td></tr><tr><td>Hidden resource confusion (flowers not visible in HUD)</td><td>Add future crafting/combo panel listing flower counts.</td></tr><tr><td>Future diff optimization complexity</td><td>Keep simple full snapshot now; encapsulate serialization for easy swap later.</td></tr></tbody></table>
<hr>
<h2 id="15-quick-reference-dev-cheatsheet">15. Quick Reference (Dev Cheatsheet)</h2>

























<table><thead><tr><th>Concern</th><th>Location / Action</th></tr></thead><tbody><tr><td>Add new object kind</td><td>Append frame to objects atlas + extend <code>ObjectId</code> union.</td></tr><tr><td>Force re-gen (dev)</td><td>Clear IndexedDB chunk keys or change world seed.</td></tr><tr><td>Adjust density</td><td><code>FLOWER_DENSITY_DIVISOR</code> constant.</td></tr><tr><td>Rendering order</td><td><code>OBJECT_DEPTH</code> constant (objects 0.5 &#x3C; player 1).</td></tr></tbody></table>
<hr>
<h2 id="16-open-questions-track--resolve-before-expanding-to-rocks">16. Open Questions (Track &#x26; Resolve Before Expanding to Rocks)</h2>
<ol>
<li>Should flower collection have its own animation or sound cue? (Placeholder now.)</li>
<li>Should we prevent flower placement on edge sand tiles of grass biome? (Currently yes— only on grass.)</li>
<li>Should inventory differentiate categories visually? (Deferred.)</li>
</ol>
<hr>
<p>End of design.</p>
<h2 id="17-current-test-coverage-step-13">17. Current Test Coverage (Step 13)</h2>
<p>Implemented tests exercising core object lifecycle:</p>
<ol>
<li><code>generation.test.ts</code> – Base tile generation determinism (seed + coords).</li>
<li><code>biomes.test.ts</code> – Deterministic biome assignment; desert palette validation.</li>
<li><code>object-generation.test.ts</code> – Flower density bounds in grass biome; absence in desert &#x26; snow biomes.</li>
<li><code>object-persistence.test.ts</code> – Removal excludes object from serialized diff and reload.</li>
<li><code>object-collection.test.ts</code> – Simulated collection: inventory increment, object removal, persistence of absence.</li>
<li><code>persistence.test.ts</code> – Tile diff serialization roundtrip.</li>
<li><code>dirty-flush.test.ts</code> / <code>metrics.test.ts</code> – Performance &#x26; dirty flush instrumentation sanity.</li>
</ol>
<p>Pending manual QA (Step 14): visual overlap, player movement during collection, multi-flower rapid collection, density tuning.</p>
<h2 id="18-future-crafting-hook">18. Future Crafting Hook</h2>
<p>Planned feature (see <a href="./CRAFTING.md">CRAFTING.md</a>): Colored sand crafting using exactly one flower + up to 10 Yellow sand blocks producing a one-for-one number of tinted sand blocks (no multiplier). Will introduce:</p>
<ul>
<li>Crafting modal (opened via minimal HUD option) listing available flower counts.</li>
<li>Deterministic recipe mapping (red: 50/50 split; others 100% single color; turquoise maps to cyan until a dark variant exists).</li>
<li>Atomic transaction: consumes inputs only if outputs fit in inventory; otherwise aborted.</li>
<li>Potential object metadata extension if certain flowers later grant special effects.</li>
</ul>
<p>Implementation deferred until after any additional QA &#x26; tuning; recipe data and execution flow defined in <code>CRAFTING.md</code>.</p>
<h2 id="19-qa--tuning-initial-metrics">19. QA &#x26; Tuning (Initial Metrics)</h2>
<p>Preliminary automated sampling (<code>density-sample.test.ts</code>) over 40 chunkX candidates at y=0 produced:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>sampled grass chunks: 15</span></span>
<span class="line"><span>mean flowers per grass chunk: ~6.87</span></span>
<span class="line"><span>min: 0</span></span>
<span class="line"><span>max: 32</span></span>
<span class="line"><span>std dev: ~10.73</span></span></code></pre>
<p>Interpretation:</p>
<ul>
<li>Actual mean significantly below naive expectation (~40–50) because many sampled chunks were small grass islands (high perimeter sand / water reducing grass tile count) and early sample size limited.</li>
<li>High variance (clusters up to 32) suggests occasional denser islands (acceptable for visual variety).</li>
<li>Some grass chunks had 0 flowers (allowed by stochastic placement; can consider guaranteed minimum later).</li>
</ul>
<p>Next QA Actions:</p>
<ol>
<li>Increase sample size (e.g., 200 chunks) to stabilize mean estimate.</li>
<li>Record average grass tile count alongside flower count to compute ratio precisely.</li>
<li>Decide on adjusting <code>FLOWER_DENSITY_DIVISOR</code> (currently 140). If target mean closer to 15–20 flowers per typical island, a divisor in the 60–90 range may be appropriate after refined measurement.</li>
<li>Add optional minimum (e.g., ensure at least 1 flower if any grass > threshold).</li>
</ol>
<p>Current Decision: Keep divisor at 140 until larger sample collected; avoid premature tuning.</p>
<h3 id="extended-sampling-120-candidates-37-grass-chunks">Extended Sampling (120 candidates, 37 grass chunks)</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>sampled grass chunks: 37</span></span>
<span class="line"><span>mean flowers per grass chunk: ~6.38</span></span>
<span class="line"><span>mean grass tiles per chunk: ~6706.59</span></span>
<span class="line"><span>flowers per grass tile ratio: ~0.00095 (≈ 1 / 1052)</span></span>
<span class="line"><span>min flowers: 0</span></span>
<span class="line"><span>max flowers: 32</span></span>
<span class="line"><span>std dev flowers: ~10.32</span></span></code></pre>
<p>Interpretation:</p>
<ul>
<li>Actual ratio (~1/1050) is much sparser than target design intent (~1/140) because grass tile heuristic counts entire predominant tile region (includes edge sand misclassification risk) and island generation yields large grass areas but low object probability.</li>
<li>To reach a target mean of ~15–20 flowers on these islands, adjust placement probability from 1/140 to roughly 1/450–1/330 (scales ratio up ~2–3x given current observed grass area; conservative starting point).</li>
<li>Recommended next tuning: set <code>FLOWER_DENSITY_DIVISOR</code> to 330, re-sample; if mean jumps near 20, optionally reduce slightly (e.g., 360–400). Provide guarantee of at least 1 flower on chunks with > 3000 grass tiles.</li>
</ul>
<p>Planned Change (deferred until approval): Update constant and add minimum guarantee logic.</p> </div> </main> <div class="backdrop"></div> <div class="app-actions"> <label for="theme-toggle" class="theme-toggle unified-button" role="button" aria-roledescription="Toggle between dark and light mode" aria-label="Toggle between dark and light mode" title="Toggle between dark and light mode"> <input type="checkbox" id="theme-toggle"> <svg class="theme-toggle-icon light" width="16" height="16" viewBox="0 0 16 16" fill="currentColor"> <path d="M8 12a4 4 0 1 1 0-8 4 4 0 0 1 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path> </svg> <svg class="theme-toggle-icon dark" width="16" height="16" viewBox="0 0 16 16" fill="currentColor"> <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path> </svg> </label> <label for="mobile-menu-toggle" class="mobile-menu-toggle unified-button" role="button" aria-roledescription="Open and close the mobile menu" aria-label="Open and close the mobile menu" title="Open and close the mobile menu"> <input type="checkbox" id="mobile-menu-toggle"> <span class="mobile-menu-toggle-icon closed">☰</span> <span class="mobile-menu-toggle-icon opened">✕</span> </label> </div> </div> </body></html>